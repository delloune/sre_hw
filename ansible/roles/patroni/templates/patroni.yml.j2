scope: {{ patroni_cluster_name }}
name: {{ ansible_hostname }}
namespace: /{{ patroni_etcd_namespace }}

log:
  level: INFO
  format: '%(asctime)s %(levelname)s: %(message)s'
  dateformat: '%Y-%m-%d %H:%M:%S'

restapi:
  listen: 0.0.0.0:{{ patroni_restapi_port }}
  connect_address: {{ patroni_bind_address }}:{{ patroni_restapi_port }}

etcd3:
  hosts: "{% for host in groups['etcd_cluster'] %}{{ hostvars[host]['bind_address'] }}:2379{% if not loop.last %},{% endif %}{% endfor %}"
  protocol: {{ patroni_etcd_protocol }}

bootstrap:
  method: initdb
  dcs:
    ttl: 30
    loop_wait: 10
    retry_timeout: 10
    maximum_lag_on_failover: {{ patroni_maximum_lag_on_failover | default(1048576) }}
    master_start_timeout: 300
    synchronous_mode: false
    postgresql:
      use_pg_rewind: true
      use_slots: true
      parameters:
        max_connections: 100
        max_wal_senders: 10
        wal_level: replica
        hot_standby: "on"
        wal_keep_size: 1GB

  initdb:
    - encoding: {{ postgresql_encoding }}
    - locale: {{ postgresql_locale }}
{% if postgresql_data_checksums %}
    - data-checksums
{% endif %}

  pg_hba:
    - host replication {{ patroni_replication_username }} 127.0.0.1/32 {{ postgresql_password_encryption_algorithm }}
    - host replication {{ patroni_replication_username }} 192.168.1.0/24 {{ postgresql_password_encryption_algorithm }}
    - host all all 0.0.0.0/0 {{ postgresql_password_encryption_algorithm }}

postgresql:
  listen: {{ postgresql_listen_addr }}:{{ postgresql_port }}
  connect_address: {{ patroni_bind_address }}:{{ postgresql_port }}
  data_dir: {{ postgresql_data_dir }}
  bin_dir: {{ postgresql_bin_dir }}
  config_dir: {{ postgresql_data_dir }}
  pgpass: {{ postgresql_home_dir }}/.pgpass_patroni
  authentication:
    replication:
      username: {{ patroni_replication_username }}
      password: {{ patroni_replication_password }}
    superuser:
      username: {{ patroni_superuser_username }}
      password: {{ patroni_superuser_password }}
  parameters:
    unix_socket_directories: /var/run/postgresql

